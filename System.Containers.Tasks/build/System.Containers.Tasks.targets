<Project>
    <PropertyGroup>
        <TargetFrameworkVersion>6.0</TargetFrameworkVersion>
    </PropertyGroup>

    <!-- Required targets dependencies -->
    <PropertyGroup>
        <PublishContainerDependsOn>
            Build;
            ComputeContainerConfig
        </PublishContainerDependsOn>
    </PropertyGroup>

    <Target Name="ComputeContainerConfig" AfterTargets="Build">

        <!-- Container Defaults -->
        <PropertyGroup>
            <_ContainerBaseImageName Condition="'$(_ContainerBaseImageName)' == '' and @(ProjectCapability->AnyHaveMetadataValue('Identity', 'AspNetCore'))">https://mcr.microsoft.com/dotnet/aspnet</_ContainerBaseImageName>
            <_ContainerBaseImageName Condition="'$(_ContainerBaseImageName)' == ''">https://mcr.microsoft.com/dotnet/runtime</_ContainerBaseImageName>
            <_ContainerBaseImageTag Condition="'$(_ContainerBaseImageTag)' == ''">$(_TargetFrameworkVersionWithoutV)</_ContainerBaseImageTag>
            <ContainerBaseImage Condition="'$(ContainerBaseImage)' == ''">$(_ContainerBaseImageName):$(_ContainerBaseImageTag)</ContainerBaseImage>
            <ContainerBaseRegistry Condition="'$(ContainerBaseRegistry)' == ''">docker://</ContainerBaseRegistry>
            <!-- Note: spaces will be replaced with '-' in ContainerImageName and ContainerImageTag -->
            <ContainerImageName Condition="'$(ContainerImageName)' == ''">$(AssemblyName)</ContainerImageName>
            <ContainerImageTag Condition="'$(ContainerImageTag)' == ''">$(Version)</ContainerImageTag>
            <ContainerWorkingDirectory Condition="'$(ContainerWorkingDirectory)' == ''">/app</ContainerWorkingDirectory>
            <!-- TODO: Test this scenario -->
            <ContainerEntrypoint Condition="'$(ContainerEntrypoint)' == '' and '$(UseAppHost)' != 'true'">dotnet $(TargetFileName)</ContainerEntrypoint>
            <ContainerEntrypoint Condition="'$(ContainerEntrypoint)' == '' and '$(UseAppHost)' == 'true'">$(ContainerWorkingDirectory)/$(AssemblyName)$(_NativeExecutableExtension)</ContainerEntrypoint>
            <!-- Could be semicolon-delimited -->
            <ContainerEntrypointArgs Condition="'$(ContainerEntrypointArgs)' == ''"></ContainerEntrypointArgs>
        </PropertyGroup>

        <ItemGroup>
            <ContainerLabel Condition="@(ContainerLabel) == ''"></ContainerLabel>
        </ItemGroup>

        <ItemGroup Condition="@(ProjectCapability->AnyHaveMetadataValue('Identity', 'AspNetCore'))">
            <ContainerPort Include="80" Type="tcp" Condition="!@(ContainerPort->WithMetadataValue('Identity', '80')->AnyHaveMetadataValue('Type', 'tcp'))" />

            <ContainerEnvironmentVariable Include="ASPNETCORE_URLS" Value="http://localhost:5000;https://localhost:5001"
                                                                    Condition="@(ContainerEnvironmentVariable->AnyHaveMetadataValue('Identity', 'ASPNETCORE_URLS'))"/>
        </ItemGroup>

        <ParseContainerProperties ContainerBaseImage="$(ContainerBaseImage)"
                                  ContainerImageName="$(ContainerImageName)"
                                  ContainerImageTag="$(ContainerImageTag)">

            <Output TaskParameter="ParsedContainerRegistry" PropertyName="_ContainerRegistry" />
            <Output TaskParameter="ParsedContainerImage" PropertyName="_ContainerImage" />
            <Output TaskParameter="ParsedContainerTag" PropertyName="_ContainerTag" />
            <Output TaskParameter="NewImageName" PropertyName="_NewImageName" />
            <Output TaskParameter="NewImageTag" PropertyName="_NewImageTag" />
        </ParseContainerProperties>
    </Target>

    <Target Name="PublishContainer" DependsOnTargets="$(PublishContainerDependsOn)" AfterTargets="ComputeContainerConfig" BeforeTargets="Publish">
        <CreateNewImage BaseRegistry="$(_ContainerRegistry)"
                        BaseImageName="$(_ContainerImage)"
                        BaseImageTag="$(_ContainerTag)"
                        OutputRegistryURL="$(ContainerOutputRegistry)"
                        PublishDirectory="$(MSBuildProjectDirectory)\$(PublishDir)"
                        NewImageName="$(_NewImageName)"
                        WorkingDirectory="$(ContainerWorkingDirectory)"
                        Entrypoint="$(ContainerEntrypoint)"
                        EntrypointArgs="$(ContainerEntrypointArgs)"/>
    </Target>
</Project>